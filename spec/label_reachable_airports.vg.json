{
    "$schema": "https://vega.github.io/schema/vega/v5.json",
    "background": "white",
    "padding": 5,
    "width": 800,
    "height": 500,
    "style": "cell",
    "data": [
      {
        "name": "source_0",
        "url": "data/us-10m.json",
        "format": {"type": "topojson", "feature": "states"}
      },
      {
        "name": "source_1",
        "url": "data/airports.csv",
        "format": {"type": "csv", "delimiter": ","}
      },
      {
        "name": "source_2",
        "url": "data/flights-airport.csv",
        "format": {
          "type": "csv",
          "parse": {"origin": "string"},
          "delimiter": ","
        },
        "transform": [
          {"type": "filter", "expr": "datum[\"origin\"]===\"SEA\""},
          {
            "type": "lookup",
            "from": "source_1",
            "key": "iata",
            "fields": ["origin"],
            "values": ["latitude", "longitude"],
            "as": ["origin_latitude", "origin_longitude"]
          },
          {
            "type": "lookup",
            "from": "source_1",
            "key": "iata",
            "fields": ["destination"],
            "values": ["latitude", "longitude", "name"],
            "as": ["dest_latitude", "dest_longitude", "name"]
          },
          {
            "type": "geojson",
            "fields": ["dest_longitude", "dest_latitude"],
            "signal": "layer_2_geojson_1"
          },
          {
            "type": "geopoint",
            "projection": "projection",
            "fields": ["origin_longitude", "origin_latitude"],
            "as": ["layer_2_x", "layer_2_y"]
          },
          {
            "type": "geopoint",
            "projection": "projection",
            "fields": ["dest_longitude", "dest_latitude"],
            "as": ["layer_2_x2", "layer_2_y2"]
          }
        ]
      },
      {
        "name": "source_3",
        "source": "source_1",
        "transform": [
          {
            "type": "lookup",
            "from": "source_2",
            "key": "destination",
            "fields": ["iata"],
            "values": ["name"],
            "as": ["is_dest"]
          },
          {"type": "filter", "expr": "datum[\"is_dest\"]===null"},
          {
            "type": "geopoint",
            "projection": "projection",
            "fields": ["longitude", "latitude"],
            "as": ["layer_1_x", "layer_1_y"]
          }
        ]
      }
    ],
    "projections": [
      {
        "name": "projection",
        "size": {"signal": "[width, height]"},
        "fit": {
          "signal": "[data('source_0'), layer_2_geojson_1]"
        },
        "type": "albersUsa"
      }
    ],
    "marks": [
      {
        "name": "us_map",
        "type": "shape",
        "style": ["geoshape"],
        "from": {"data": "source_0"},
        "encode": {
          "update": {
            "fill": {"value": null},
            "stroke": {"value": "lightgray"},
            "strokeWidth": {"value": 1}
          }
        },
        "transform": [{"type": "geoshape", "projection": "projection"}]
      },
      {
        "name": "airport_points",
        "type": "symbol",
        "style": ["circle"],
        "from": {"data": "source_3"},
        "zindex": 2,
        "encode": {
          "update": {
            "opacity": {"value": 1},
            "fill": {"value": "darkgray"},
            "x": {"field": "layer_1_x"},
            "y": {"field": "layer_1_y"},
            "size": {"value": 4},
            "shape": {"value": "circle"}
          }
        }
      },
      {
        "name": "reachable_lines",
        "type": "rule",
        "style": ["rule"],
        "from": {"data": "source_2"},
        "zindex": 2,
        "encode": {
          "update": {
            "stroke": {"value": "black"},
            "strokeWidth": {"value": 1},
            "x": {"field": "layer_2_x"},
            "x2": {"field": "layer_2_x2"},
            "y": {"field": "layer_2_y"},
            "y2": {"field": "layer_2_y2"}
          }
        }
      },
      {
        "name": "reachable_endpoints",
        "type": "symbol",
        "style": ["circle"],
        "from": {"data": "reachable_lines"},
        "zindex": 2,
        "encode": {
          "update": {
            "size": {"value": 6},
            "fill": {"value": "black"},
            "x": {"field": "x2"},
            "y": {"field": "y2"}
          }
        }
      },
      {
        "name": "label_endpoints",
        "type": "text",
        "from": {"data": "reachable_endpoints"},
        "zindex": 2,
        "encode": {
          "enter": {
            "x": {"field": "x"},
            "y": {"field": "y"},
            "fill": {"value": "firebrick"},
            "text": {"field": "datum.datum.name"},
            "fontSize": {"value": 7}
          }
        },
        "transform": [{
          "type": "label",
          "size": [500, 300],
          "avoidMarks": ["reachable_lines", "reachable_endpoints"]
        }]
      },
      {
        "name": "label_endpoints_background",
        "type": "rect",
        "from": {"data": "label_endpoints"},
        "zindex": 1,
        "encode": {
          "enter": {
            "x": {"field": "x0"},
            "y": {"field": "y0"},
            "x2": {"field": "x1"},
            "y2": {"field": "y1"},
            "fillOpacity": {"value": 0.1},
            "fill": {"field": "fill"},
            "strokeOpacity": {"value": 0.3},
            "stroke": {"field": "fill"}
          }
        }
      },
      {
        "name": "label_airports",
        "type": "text",
        "from": {"data": "airport_points"},
        "zindex": 2,
        "encode": {
          "enter": {
            "x": {"field": "x"},
            "y": {"field": "y"},
            "fill": {"value": "teal"},
            "text": {"field": "datum.name"},
            "fontSize": {"value": 5}
          }
        },
        "transform": [{
          "type": "label",
          "size": [500, 300],
          "avoidMarks": ["reachable_lines", "label_endpoints_background", "reachable_endpoints", "us_map", "airport_points"]
        }]
      },
      {
        "name": "label_airports_background",
        "type": "rect",
        "from": {"data": "label_airports"},
        "zindex": 1,
        "encode": {
          "enter": {
            "x": {"field": "x0"},
            "y": {"field": "y0"},
            "x2": {"field": "x1"},
            "y2": {"field": "y1"},
            "fillOpacity": {"value": 0.1},
            "fill": {"field": "fill"},
            "strokeOpacity": {"value": 0.3},
            "stroke": {"field": "fill"}
          }
        }
      },
      {
        "name": "label_airports_rule",
        "type": "rule",
        "from": {"data": "label_airports"},
        "zindex": 1,
        "encode": {
          "enter": {
            "x": {"field": "datum.x"},
            "y": {"field": "datum.y"},
            "x2": {"field": "xAnchor"},
            "y2": {"field": "yAnchor"},
            "strokeOpacity": {"value": 0.3},
            "stroke": {"field": "fill"}
          }
        }
      },
      {
        "name": "label_endpoints_rule",
        "type": "rule",
        "from": {"data": "label_endpoints"},
        "zindex": 1,
        "encode": {
          "enter": {
            "x": {"field": "datum.x"},
            "y": {"field": "datum.y"},
            "x2": {"field": "xAnchor"},
            "y2": {"field": "yAnchor"},
            "strokeOpacity": {"value": 0.3},
            "stroke": {"field": "fill"}
          }
        }
      }
    ]
  }